# КАДРЫ - Руководство по установке и использованию

## Оглавление
1. [Что нужно для установки](#1-что-нужно-для-установки)
2. [Установка с нуля (пошагово)](#2-установка-с-нуля-пошагово)
3. [Первый вход в систему](#3-первый-вход-в-систему)
4. [Заполнение тестовыми данными](#4-заполнение-тестовыми-данными)
5. [Очистка базы данных](#5-очистка-базы-данных)
6. [Повседневное управление](#6-повседневное-управление)
7. [Резервное копирование](#7-резервное-копирование)
8. [Обновление системы](#8-обновление-системы)
9. [Решение проблем](#9-решение-проблем)
10. [Руководство пользователя](#10-руководство-пользователя)

---

## 1. Что нужно для установки

На сервере (или компьютере) должны быть установлены:

| Программа | Зачем нужна | Как проверить |
|-----------|-------------|---------------|
| **Docker** | Запуск контейнеров | `docker --version` |
| **Docker Compose** | Управление контейнерами | `docker compose version` |
| **Git** | Скачивание кода | `git --version` |

### Установка Docker (если ещё нет)

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install -y docker.io docker-compose-plugin
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker $USER
# Перезайдите в систему после этой команды
```

**Windows:**
Скачайте и установите [Docker Desktop](https://www.docker.com/products/docker-desktop/)

**macOS:**
```bash
brew install --cask docker
```

---

## 2. Установка с нуля (пошагово)

### Шаг 1. Скачайте код

```bash
git clone https://github.com/Komili/HR.git
cd HR
```

### Шаг 2. Создайте файл настроек

```bash
cp .env.example .env
```

Откройте файл `.env` в текстовом редакторе и **измените пароли**:

```bash
nano .env    # Linux
notepad .env # Windows
```

Содержимое файла `.env`:
```ini
# База данных MySQL
MYSQL_USER=hrms
MYSQL_PASSWORD=ВАШ_ПАРОЛЬ_ДЛЯ_БД
MYSQL_ROOT_PASSWORD=ВАШ_ROOT_ПАРОЛЬ
MYSQL_DATABASE=hrms

# ВАЖНО: пароль после "hrms:" должен совпадать с MYSQL_PASSWORD выше
DATABASE_URL="mysql://hrms:ВАШ_ПАРОЛЬ_ДЛЯ_БД@db:3306/hrms"

# JWT секрет (придумайте длинную случайную строку)
JWT_SECRET=придумайте-свой-секретный-ключ-тут

# Не менять:
PORT=7070
NEXT_PUBLIC_API_URL=/api
```

> **Важно!** Пароль в `MYSQL_PASSWORD` и в `DATABASE_URL` после `hrms:` должен быть **одинаковым**.

### Шаг 3. Запустите систему

```bash
docker compose up --build -d
```

Первый запуск займёт **5-15 минут** (скачиваются образы, компилируется код).

### Шаг 4. Проверьте, что всё работает

```bash
docker compose ps
```

Вы должны увидеть 4 контейнера со статусом `Up`:
```
NAME            STATUS
hrms_db         Up (healthy)
hrms_backend    Up (healthy)
hrms_frontend   Up
hrms_nginx      Up
```

Если `hrms_backend` показывает `(unhealthy)`, подождите 1-2 минуты — бэкенд может ещё запускаться.

### Шаг 5. Примените схему базы данных

```bash
docker compose exec backend npx prisma db push
```

Эта команда создаст все таблицы в базе данных.

### Шаг 6. Создайте администратора и начальные роли

```bash
docker compose exec backend node prisma/seed.js
```

Эта команда создаст:
- Роли системы (Суперадмин, Кадровик, Руководитель, Бухгалтер, Сотрудник)
- 8 компаний холдинга
- Администратора: `admin@holding.tj` / `password`
- Тестовых пользователей для каждой компании
- ~140 тестовых сотрудников с посещаемостью и зарплатами

### Шаг 7. Откройте систему

Откройте в браузере: **http://ваш-сервер:7474**

Или если устанавливаете на своём компьютере: **http://localhost:7474**

---

## 3. Первый вход в систему

### Учётная запись администратора

| Поле | Значение |
|------|----------|
| Email | `admin@holding.tj` |
| Пароль | `password` |

> **Сразу после первого входа** зайдите в Админ-панель и смените пароль администратора!

### Что может администратор

После входа как администратор, вы можете:

1. **Админ-панель** (в меню слева, раздел "Администрирование"):
   - Создавать пользователей для каждой компании
   - Назначать роли (Кадровик, Руководитель, Бухгалтер)
   - Менять пароли пользователей
   - Управлять компаниями

2. **Переключаться между компаниями** (выпадающий список в боковой панели)

3. **Видеть все данные** всех компаний холдинга

### Тестовые пользователи (после seed)

| Email | Пароль | Роль | Компания |
|-------|--------|------|----------|
| `admin@holding.tj` | `password` | Суперадмин | Все компании |
| `hr@bunyod.tj` | `password` | Кадровик | Бунёд Интернешнл |
| `manager@bunyod.tj` | `password` | Руководитель | Бунёд Интернешнл |
| `accountant@bunyod.tj` | `password` | Бухгалтер | Бунёд Интернешнл |
| `hr@favz.tj` | `password` | Кадровик | Фавз |
| `manager@favz.tj` | `password` | Руководитель | Фавз |

Также есть кадровики для каждой компании (`hr@dezinfection.tj`, `hr@makon.tj`, и т.д.)

### Роли и права доступа

| Роль | Что может делать |
|------|-----------------|
| **Суперадмин** | Всё: все компании, управление пользователями, админ-панель |
| **Кадровик** | CRUD сотрудников, отделов, должностей, документов (только своя компания) |
| **Руководитель** | Просмотр сотрудников, посещаемости, корректировка времени (только своя компания) |
| **Бухгалтер** | Просмотр сотрудников, зарплат (только своя компания) |
| **Сотрудник** | Нет доступа к данным |

---

## 4. Заполнение тестовыми данными

Если вы хотите заполнить систему тестовыми данными (сотрудники, посещаемость, зарплаты, инвентарь):

```bash
docker compose exec backend node prisma/seed.js
```

> **Внимание:** Эта команда **удалит все существующие данные** и создаст новые тестовые.

Будет создано:
- 8 компаний с отделами и должностями
- ~140 сотрудников с таджикскими именами
- 3 месяца данных посещаемости
- Расчёт зарплат за прошедшие месяцы
- ~100 единиц инвентаря
- 2-3 офиса для каждой компании

---

## 5. Очистка базы данных

Если нужно **полностью очистить все данные** и начать с нуля (остаётся только администратор):

```bash
docker compose exec backend node prisma/clean-db.js
```

После очистки в системе останутся:
- Роли (Суперадмин, Кадровик и т.д.)
- Администратор `admin@holding.tj`

Всё остальное (компании, сотрудники, пользователи) будет удалено.

---

## 6. Повседневное управление

### Запуск системы
```bash
docker compose start
```

### Остановка системы (данные сохраняются)
```bash
docker compose stop
```

### Перезапуск
```bash
docker compose restart
```

### Полная остановка с удалением контейнеров (данные сохраняются)
```bash
docker compose down
```

### Просмотр логов
```bash
# Все контейнеры
docker compose logs -f

# Только бэкенд
docker compose logs -f backend

# Только фронтенд
docker compose logs -f frontend

# Последние 50 строк
docker compose logs --tail=50 backend
```

### Проверка статуса
```bash
docker compose ps
```

---

## 7. Резервное копирование

### Резервная копия базы данных

```bash
# Создать бэкап
docker compose exec db mysqldump -u hrms -p hrms > backup_$(date +%Y%m%d).sql
# Введите пароль из MYSQL_PASSWORD

# Восстановить из бэкапа
docker compose exec -T db mysql -u hrms -p hrms < backup_20260213.sql
```

### Резервная копия файлов (документы сотрудников)

Файлы хранятся в папке `storage/` в корне проекта:
```bash
# Создать архив
tar -czf storage_backup_$(date +%Y%m%d).tar.gz storage/

# Восстановить
tar -xzf storage_backup_20260213.tar.gz
```

### Автоматический бэкап (cron)

Добавьте в crontab для ежедневного бэкапа в 3:00 ночи:
```bash
crontab -e
```
```
0 3 * * * cd /путь/к/HR && docker compose exec -T db mysqldump -u hrms -pВАШ_ПАРОЛЬ hrms > /путь/к/бэкапам/hrms_$(date +\%Y\%m\%d).sql
```

---

## 8. Обновление системы

```bash
# 1. Скачать обновления
git pull

# 2. Пересобрать и перезапустить
docker compose up --build -d

# 3. Применить изменения в БД (если были изменения схемы)
docker compose exec backend npx prisma db push
```

---

## 9. Решение проблем

### Контейнер backend показывает "unhealthy"

Подождите 1-2 минуты. Если не помогло:
```bash
docker compose logs backend
```
Ищите ошибки в логах. Частая причина — неправильный пароль БД в `.env`.

### Не могу зайти на http://localhost:7474

1. Проверьте, что все контейнеры запущены: `docker compose ps`
2. Проверьте, не занят ли порт 7474: `netstat -tlnp | grep 7474`
3. Попробуйте другой порт — измените `7474:80` в `docker-compose.yml`

### Ошибка "Access denied" при входе

- Проверьте правильность email и пароля
- Убедитесь, что seed был выполнен: `docker compose exec backend node prisma/seed.js`

### Ошибка "Foreign key constraint" при удалении

Это значит, что у объекта есть связанные данные. Например, нельзя удалить отдел, если в нём есть сотрудники. Сначала переведите сотрудников в другой отдел.

### Порт 7474 занят

Измените порт в `docker-compose.yml`:
```yaml
nginx:
  ports:
    - "8080:80"   # было "7474:80"
```
Затем: `docker compose up -d`

### Полный сброс системы

Если что-то пошло совсем не так:
```bash
# Остановить и удалить всё (включая базу данных!)
docker compose down -v

# Запустить заново
docker compose up --build -d

# Подождать пока БД запустится, затем:
docker compose exec backend npx prisma db push
docker compose exec backend node prisma/seed.js
```

> **Внимание:** `docker compose down -v` удаляет ВСЕ данные включая базу!

---

## 10. Руководство пользователя

### Вход в систему

1. Откройте браузер
2. Перейдите по адресу системы (например, `http://192.168.1.100:7474`)
3. Введите email и пароль, выданные администратором

### Главная страница (Дашборд)

После входа отображается статистика: количество сотрудников, отделов, компаний.

### Сотрудники

- **Список**: Таблица со всеми сотрудниками. Поиск по имени, email, отделу
- **Создание**: Кнопка "Добавить сотрудника" -> заполнить форму -> "Сохранить"
- **Профиль**: Клик по имени -> полная информация, документы, посещаемость, инвентарь
- **Экспорт**: Кнопка "Экспорт" -> скачивается Excel-файл

### Документы

1. Откройте профиль сотрудника
2. Вкладка "Документы"
3. Кнопка "Загрузить" напротив типа документа
4. Выберите файл -> загрузится автоматически

### Посещаемость

- Раздел "Посещаемость" в меню
- Выбор даты -> таблица с приходами/уходами
- Цветовая кодировка: зелёный = на месте, красный = ушёл, серый = отсутствует
- Корректировка времени (для Кадровика/Руководителя): клик по строке -> ±30/60/90 минут

### Зарплата

- Раздел "Зарплата" в меню
- Выбор месяца/года -> расчёт на основе посещаемости
- Кнопка "Рассчитать" -> автоматический расчёт для всех сотрудников

### Инвентарь

- Раздел "Инвентарь" в меню
- Создание, редактирование, привязка к сотруднику
- История изменений для каждой единицы

### Оргструктура

- Раздел "Оргструктура" в меню
- Визуальная древовидная структура компании

### Админ-панель (только для Суперадмина)

- Раздел "Админ-панель" в меню (жёлтая иконка)
- Вкладка "Пользователи": создание, редактирование, смена пароля, деактивация
- Вкладка "Компании": управление компаниями холдинга

---

## Порты системы

| Сервис | Порт | Описание |
|--------|------|----------|
| **Nginx (вход)** | **7474** | Основной вход в систему |
| MySQL | 7171 | База данных (для прямого подключения) |
| Backend | 7272 | API (для отладки) |
| Frontend | 7373 | Веб-интерфейс (для отладки) |

Для доступа к системе используйте порт **7474** — он объединяет фронтенд и бэкенд через Nginx.

---

## Структура файлов проекта

```
HR/
├── .env                    # Настройки (пароли, ключи) - НЕ коммитить!
├── .env.example            # Шаблон настроек
├── docker-compose.yml      # Конфигурация Docker
├── storage/                # Загруженные файлы (документы, фото)
├── backend/                # Серверная часть (NestJS)
│   ├── Dockerfile
│   ├── prisma/
│   │   ├── schema.prisma   # Схема базы данных
│   │   ├── seed.js         # Заполнение тестовыми данными
│   │   └── clean-db.js     # Очистка базы данных
│   └── src/                # Исходный код API
├── frontend/               # Клиентская часть (Next.js)
│   ├── Dockerfile
│   └── app/                # Страницы и компоненты
├── docker/
│   └── nginx/
│       └── default.conf    # Настройки Nginx
└── docs/                   # Документация
    └── ИНСТРУКЦИЯ.md       # Этот файл
```
