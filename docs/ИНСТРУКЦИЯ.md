# КАДРЫ — Руководство по установке и использованию

## Оглавление
1. [Что нужно для установки](#1-что-нужно-для-установки)
2. [Установка с нуля (пошагово)](#2-установка-с-нуля-пошагово)
3. [Первый вход в систему](#3-первый-вход-в-систему)
4. [Повседневное управление](#4-повседневное-управление)
5. [Резервное копирование](#5-резервное-копирование)
6. [Обновление системы](#6-обновление-системы)
7. [Решение проблем](#7-решение-проблем)
8. [Руководство пользователя](#8-руководство-пользователя)

---

## 1. Что нужно для установки

На сервере (или компьютере) должны быть установлены:

| Программа | Зачем нужна | Как проверить |
|-----------|-------------|---------------|
| **Docker** | Запуск контейнеров | `docker --version` |
| **Docker Compose** | Управление контейнерами | `docker compose version` |

### Установка Docker

**Ubuntu/Debian:**
```bash
sudo apt update
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
newgrp docker
```

**Windows:** скачайте [Docker Desktop](https://www.docker.com/products/docker-desktop/)

---

## 2. Установка с нуля (пошагово)

### Шаг 1. Скопируйте файлы проекта

```bash
# Вариант А: через rsync (с исходной машины)
rsync -avz --exclude='node_modules' --exclude='.next' --exclude='dist' \
      --exclude='.env' --exclude='storage' --exclude='skud.sql' \
      /c/repos/HR/ user@SERVER_IP:/opt/hrms/

# Вариант Б: через git
git clone https://ВАШ_РЕПОЗИТОРИЙ /opt/hrms
```

### Шаг 2. Создайте файл настроек

```bash
cd /opt/hrms
cp .env.example .env
nano .env
```

Содержимое `.env`:
```ini
# База данных MySQL
MYSQL_USER=hrms
MYSQL_PASSWORD=ВАШ_НАДЁЖНЫЙ_ПАРОЛЬ
MYSQL_ROOT_PASSWORD=ВАШ_ROOT_ПАРОЛЬ
MYSQL_DATABASE=hrms

# ВАЖНО: пароль после "hrms:" должен совпадать с MYSQL_PASSWORD выше
DATABASE_URL="mysql://hrms:ВАШ_НАДЁЖНЫЙ_ПАРОЛЬ@db:3306/hrms"

# JWT секрет — сгенерировать случайный (минимум 32 символа)
JWT_SECRET=сгенерируйте-случайную-строку-минимум-32-символа

# Не менять:
PORT=7070
NEXT_PUBLIC_API_URL=/api
```

Генерация JWT секрета:
```bash
openssl rand -base64 48
```

### Шаг 3. Запустите систему

```bash
cd /opt/hrms
docker compose up -d --build
```

Первый запуск займёт **5–15 минут** (скачиваются образы, компилируется код).

### Шаг 4. Проверьте, что всё работает

```bash
docker compose ps
```

Все 4 контейнера должны иметь статус `Up`:
```
NAME            STATUS
hrms_db         Up (healthy)
hrms_backend    Up (healthy)
hrms_frontend   Up
hrms_nginx      Up
```

### Шаг 5. Примените схему базы данных

```bash
docker compose exec backend npx prisma db push
```

### Шаг 6. Создайте структуру базы данных

```bash
docker compose exec backend node prisma/seed.js
```

Эта команда создаст:
- 5 ролей (Суперадмин, Кадровик, Руководитель, Бухгалтер, Сотрудник)
- 9 компаний холдинга
- Администратора: `admin@holding.tj` / `password`

### Шаг 7. Создайте папку для временных файлов

```bash
docker exec hrms_backend mkdir -p /app/storage/tmp
```

### Шаг 8. Загрузите данные из СКУД

```bash
# Скопировать файл данных СКУД в контейнер
docker cp /путь/к/skud.sql hrms_backend:/app/skud.sql

# Скопировать скрипты импорта
docker cp backend/prisma/import-skud.js hrms_backend:/app/prisma/import-skud.js
docker cp backend/prisma/organize-photos.js hrms_backend:/app/prisma/organize-photos.js

# Запустить импорт (~2–5 минут)
docker compose exec backend node prisma/import-skud.js
```

Ожидаемый результат:
```
✅ Компании:       9
✅ Сотрудники:     203
✅ События:        11074
✅ Дневные сводки: 2723
✅ Пользователи:   ~30
```

### Шаг 9. Разложите фото сотрудников

```bash
# Скопировать папку skud-photos на сервер (если не скопирована)
rsync -avz --progress /c/repos/HR/storage/skud-photos/ user@SERVER_IP:/opt/hrms/storage/skud-photos/

# Запустить организацию фото
docker compose exec backend node prisma/organize-photos.js
```

### Шаг 10. Откройте систему

```
http://SERVER_IP:7474
```

---

## 3. Первый вход в систему

### Учётная запись администратора

| Поле | Значение |
|------|----------|
| Email | `admin@holding.tj` |
| Пароль | `password` |

> **Сразу после первого входа** зайдите в Админ-панель и смените пароль!

### Что нужно сделать после первого входа

1. **Сменить пароль администратора** — Админ-панель → Пользователи → admin@holding.tj → Сменить пароль
2. **Проверить пользователей компаний** — после импорта СКУД создаются HR-пользователи (`hr@company.tj`) с паролем `password` — сменить пароли
3. **Проверить фото сотрудников** — раздел Сотрудники

### Пользователи, созданные при импорте СКУД

Для каждой компании создаются 3 пользователя (пароль по умолчанию: `password`):

| Роль | Email (пример) |
|------|----------------|
| Кадровик | `hr@bunyod.tj`, `hr@favz.tj`, `hr@makon.tj`, ... |
| Руководитель | `manager@bunyod.tj`, `manager@favz.tj`, ... |
| Бухгалтер | `accountant@bunyod.tj`, `accountant@favz.tj`, ... |

> **Обязательно смените пароли** всех пользователей через Админ-панель → Пользователи!

### Роли и права доступа

| Роль | Что может делать |
|------|-----------------|
| **Суперадмин** | Всё: все компании, управление пользователями, админ-панель |
| **Кадровик** | CRUD сотрудников, отделов, должностей, документов, регистраций (только своя компания) |
| **Руководитель** | Просмотр сотрудников, посещаемости, корректировка времени (только своя компания) |
| **Бухгалтер** | Просмотр сотрудников, зарплат (только своя компания) |
| **Сотрудник** | Нет доступа к данным |

---

## 4. Повседневное управление

### Запуск системы после перезагрузки сервера
```bash
cd /opt/hrms
docker compose up -d
```

Docker настроен на автозапуск (`restart: unless-stopped`). Убедитесь что Docker запускается автоматически:
```bash
sudo systemctl enable docker
```

### Остановка системы (данные сохраняются)
```bash
docker compose stop
```

### Перезапуск
```bash
docker compose restart
```

### Просмотр логов
```bash
docker compose logs -f backend    # логи бэкенда
docker compose logs -f frontend   # логи фронтенда
docker compose logs -f nginx      # логи nginx
docker compose logs -f db         # логи MySQL
```

### Проверка статуса
```bash
docker compose ps
```

### Полный сброс и переимпорт данных
```bash
cd /opt/hrms

# 1. Сбросить схему БД
docker compose exec backend npx prisma db push --force-reset

# 2. Создать структуру (роли, компании, суперадмин)
docker compose exec backend node prisma/seed.js

# 3. Создать tmp папку
docker exec hrms_backend mkdir -p /app/storage/tmp

# 4. Импортировать данные СКУД
docker cp skud.sql hrms_backend:/app/skud.sql
docker cp backend/prisma/import-skud.js hrms_backend:/app/prisma/import-skud.js
docker compose exec backend node prisma/import-skud.js

# 5. Разложить фото
docker cp backend/prisma/organize-photos.js hrms_backend:/app/prisma/organize-photos.js
docker compose exec backend node prisma/organize-photos.js
```

---

## 5. Резервное копирование

### Резервная копия базы данных

```bash
# Создать дамп
docker compose exec db mysqldump \
    -u hrms -p'ВАШ_ПАРОЛЬ' hrms > backup_$(date +%Y%m%d).sql

# Восстановить из дампа
docker compose exec -T db mysql \
    -u hrms -p'ВАШ_ПАРОЛЬ' hrms < backup_20260225.sql
```

### Резервная копия файлов (фото, документы)

```bash
# Создать архив
tar -czf storage_backup_$(date +%Y%m%d).tar.gz /opt/hrms/storage/companies/

# Восстановить
tar -xzf storage_backup_20260225.tar.gz -C /opt/hrms/
```

### Автоматический бэкап (cron)

```bash
crontab -e
```
```
0 3 * * * cd /opt/hrms && docker compose exec -T db mysqldump -u hrms -pВАШ_ПАРОЛЬ hrms > /opt/backups/hrms_$(date +\%Y\%m\%d).sql
```

---

## 6. Обновление системы

```bash
cd /opt/hrms

# 1. Получить обновлённый код
git pull
# или скопировать через rsync

# 2. Пересобрать контейнеры
docker compose up -d --build

# 3. Применить изменения схемы БД (если были)
docker compose exec backend npx prisma db push
```

---

## 7. Решение проблем

### Белая страница или ошибки JS в браузере
```bash
docker compose restart nginx
```

### Контейнер backend показывает "unhealthy"
```bash
docker compose logs backend
```
Частая причина — неправильный пароль в `DATABASE_URL` в файле `.env`.

### Нет доступа на http://SERVER_IP:7474
```bash
# Проверить что контейнеры запущены
docker compose ps

# Проверить firewall
sudo ufw allow 7474/tcp       # Ubuntu
```

### Ошибка "Cannot GET /" или 404
```bash
docker compose restart nginx
# Подождать 5 секунд и обновить страницу
```

### База данных не подключается
```bash
# Проверить логи БД
docker compose logs db

# Убедиться что пароль в DATABASE_URL совпадает с MYSQL_PASSWORD
```

### Ошибка "Salary table does not exist" или ошибки схемы
```bash
# НЕ использовать migrate reset — использовать db push
docker compose exec backend npx prisma db push --force-reset
docker cp backend/prisma/import-skud.js hrms_backend:/app/prisma/import-skud.js
docker compose exec backend node prisma/import-skud.js
```

### Фото не отображаются
```bash
docker cp backend/prisma/organize-photos.js hrms_backend:/app/prisma/organize-photos.js
docker compose exec backend node prisma/organize-photos.js
```

### Полный сброс (если что-то пошло не так)
```bash
# ВНИМАНИЕ: удалит ВСЕ данные включая базу!
docker compose down -v
docker compose up -d --build

# Затем повторить шаги 5–9 из раздела "Установка"
```

---

## 8. Руководство пользователя

### Вход в систему

1. Откройте браузер
2. Перейдите по адресу системы: `http://SERVER_IP:7474`
3. Введите email и пароль

### Главная страница (Дашборд)

Статистика: количество сотрудников, посещаемость сегодня, компании.

### Сотрудники

- **Список**: таблица с фото, поиск по имени
- **Создание**: кнопка "Добавить сотрудника"
- **Профиль**: клик по имени → полная информация, документы, посещаемость, инвентарь, зарплата
- **Экспорт**: кнопка "Экспорт" → скачивается CSV

### Регистрация нового сотрудника через QR-код

1. Войти как Кадровик → раздел **Регистрации** → вкладка **QR-коды**
2. Нажать **"Создать QR"**
3. Распечатать QR-код или скопировать ссылку
4. Новый сотрудник сканирует QR-код телефоном → заполняет анкету → фотографируется
5. Кадровик в разделе **Регистрации → Заявки** видит новую заявку
6. Нажать **"Одобрить"** → выбрать отдел и должность → сотрудник появляется в общем списке

### Посещаемость

- Раздел "Посещаемость" в меню
- Выбор даты → таблица с приходами/уходами
- Цвета: зелёный = на месте, красный = ушёл, серый = отсутствует
- Корректировка времени: кнопка "Коррекция" → ±минуты

### Зарплата

- Раздел "Зарплата" → выбор месяца/года
- Кнопка "Рассчитать" → автоматический расчёт на основе посещаемости
- Редактирование: премии, удержания, заметки

### Инвентарь

- Создание, редактирование, привязка к сотруднику
- История изменений для каждой единицы

### Оргструктура

- Визуальная древовидная структура компании

### Админ-панель (только Суперадмин)

- **Пользователи**: создание, редактирование, смена пароля, деактивация
- **Компании**: управление компаниями холдинга

---

## Порты системы

| Сервис | Порт | Описание |
|--------|------|----------|
| **Nginx (вход)** | **7474** | Основной вход — открыть в firewall |
| MySQL | 7171 | База данных — только внутри сервера |
| Backend | 7272 | API — только внутри сервера |
| Frontend | 7373 | Веб-интерфейс — только внутри сервера |

Открывать наружу только порт **7474**.

---

## Структура файлов проекта

```
/opt/hrms/
├── backend/
│   ├── src/                    # Исходный код API (NestJS)
│   ├── prisma/
│   │   ├── schema.prisma       # Схема базы данных
│   │   ├── seed.js             # Инициализация: роли, компании, суперадмин
│   │   ├── import-skud.js      # Импорт данных из СКУД
│   │   └── organize-photos.js  # Раскладывание фото по папкам
│   └── Dockerfile
├── frontend/
│   ├── app/                    # Страницы
│   ├── components/             # UI-компоненты
│   └── Dockerfile
├── docker/
│   └── nginx/default.conf      # Конфигурация Nginx
├── storage/
│   ├── companies/              # Фото и документы сотрудников (~940 MB)
│   ├── skud-photos/            # Оригинальные фото из СКУД (~780 MB)
│   └── tmp/                    # Временные файлы загрузок
├── skud.sql                    # Дамп данных СКУД (не в git)
├── docker-compose.yml
├── .env                        # Секреты — создать вручную из .env.example!
└── .env.example                # Шаблон настроек
```
