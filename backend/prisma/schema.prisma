// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Модели данных для мультитенантной HR системы холдинга

// Компания холдинга
model Company {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  shortName   String?    // Краткое название
  inn         String?    // ИНН компании
  address     String?
  phone       String?
  email       String?
  isActive    Boolean    @default(true)
  users       User[]
  employees      Employee[]
  departments    Department[]
  positions      Position[]
  documents      EmployeeDocument[]
  inventoryItems   InventoryItem[]
  offices          Office[]
  attendanceEvents AttendanceEvent[]
  attendances      Attendance[]
  salaries             Salary[]
  registrationTokens   RegistrationToken[]
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

model User {
  id             Int      @id @default(autoincrement())
  email          String   @unique
  password       String
  firstName      String?  // Имя пользователя
  lastName       String?  // Фамилия пользователя
  role           Role     @relation(fields: [roleId], references: [id])
  roleId         Int
  company        Company? @relation(fields: [companyId], references: [id])
  companyId      Int?     // null для суперадминов холдинга
  isHoldingAdmin Boolean  @default(false) // Суперадмин холдинга
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique // "Суперадмин", "Кадровик", "Руководитель", "Бухгалтер", "Сотрудник"
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employee {
  id              Int                @id @default(autoincrement())
  firstName       String
  lastName        String
  patronymic      String?
  latinFirstName  String
  latinLastName   String
  birthDate       DateTime?
  passportSerial  String?
  passportNumber  String?
  passportIssuedBy String?
  passportIssueDate DateTime?
  inn             String?
  address         String?
  phone           String?
  email           String?
  salary          Float?
  contractNumber  String?
  contractDate    DateTime?
  hireDate        DateTime?
  status          String             @default("Активен") // "Активен", "Уволен", "В отпуске"
  notes           String?            @db.Text
  photoPath       String?            // Путь к фото сотрудника
  company         Company            @relation(fields: [companyId], references: [id])
  companyId       Int
  department      Department?        @relation(fields: [departmentId], references: [id])
  departmentId    Int?
  position        Position?          @relation(fields: [positionId], references: [id])
  positionId      Int?
  documents        EmployeeDocument[]
  inventoryItems   InventoryItem[]
  attendanceEvents AttendanceEvent[]
  attendances      Attendance[]
  salaries         Salary[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([companyId])
}

model Department {
  id        Int        @id @default(autoincrement())
  name      String
  company   Company    @relation(fields: [companyId], references: [id])
  companyId Int
  employees Employee[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([name, companyId]) // Уникальное название в рамках компании
  @@index([companyId])
}

model Position {
  id        Int        @id @default(autoincrement())
  name      String
  company   Company    @relation(fields: [companyId], references: [id])
  companyId Int
  employees Employee[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([name, companyId]) // Уникальное название в рамках компании
  @@index([companyId])
}

model EmployeeDocument {
  id         Int      @id @default(autoincrement())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId Int
  company    Company  @relation(fields: [companyId], references: [id])
  companyId  Int
  type       String   // "Паспорт", "ИНН", etc.
  filePath   String
  fileName   String
  uploadedBy String   // Можно будет связать с User ID
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([companyId])
  @@index([employeeId])
}

model InventoryItem {
  id              Int                @id @default(autoincrement())
  name            String
  model           String?
  category        String?    // Компьютеры, Мебель, Оргтехника, etc.
  inventoryNumber String?    // Инвентарный номер
  price           Float?
  acquisitionDate DateTime?  // Дата приобретения
  description     String?    @db.Text
  status          String     @default("В наличии") // В наличии, Выдан, В ремонте, Списан
  company         Company    @relation(fields: [companyId], references: [id])
  companyId       Int
  employee        Employee?  @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  employeeId      Int?
  history         InventoryHistory[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([inventoryNumber, companyId])
  @@index([companyId])
  @@index([employeeId])
}

model InventoryHistory {
  id              Int           @id @default(autoincrement())
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  inventoryItemId Int
  action          String        // "Создан", "Изменён", "Выдан", "Возвращён", "Удалён"
  details         String?       @db.Text
  employeeName    String?       // ФИО сотрудника (при выдаче/возврате)
  performedBy     String        // Email пользователя
  createdAt       DateTime      @default(now())

  @@index([inventoryItemId])
}

model Office {
  id               Int               @id @default(autoincrement())
  name             String
  address          String?
  company          Company           @relation(fields: [companyId], references: [id])
  companyId        Int
  createdAt        DateTime          @default(now())
  attendanceEvents AttendanceEvent[]

  @@unique([name, companyId])
  @@index([companyId])
}

model AttendanceEvent {
  id         Int      @id @default(autoincrement())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId Int
  company    Company  @relation(fields: [companyId], references: [id])
  companyId  Int
  timestamp  DateTime
  direction  String   // "IN" | "OUT"
  deviceName String?
  office     Office?  @relation(fields: [officeId], references: [id])
  officeId   Int?
  createdAt  DateTime @default(now())

  @@index([employeeId, timestamp])
  @@index([companyId, timestamp])
}

model Attendance {
  id                Int      @id @default(autoincrement())
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId        Int
  company           Company  @relation(fields: [companyId], references: [id])
  companyId         Int
  date              DateTime @db.Date
  firstEntry        DateTime?
  lastExit          DateTime?
  status            String   @default("present") // present|left|absent|excused
  totalMinutes      Int      @default(0)
  correctionMinutes Int      @default(0)
  correctedBy       String?
  correctionNote    String?
  officeName        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([companyId, date])
}

model Salary {
  id              Int      @id @default(autoincrement())
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId      Int
  company         Company  @relation(fields: [companyId], references: [id])
  companyId       Int
  month           Int      // 1-12
  year            Int
  baseSalary      Float    @default(0) // Оклад
  workedDays      Int      @default(0) // Рабочих дней
  totalDays       Int      @default(0) // Всего рабочих дней в месяце
  workedHours     Int      @default(0) // Отработано минут
  bonus           Float    @default(0) // Премия
  deduction       Float    @default(0) // Удержание
  note            String?  @db.Text
  totalAmount     Float    @default(0) // Итого к выплате
  calculatedBy    String?  // Email кто рассчитал
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([employeeId, month, year])
  @@index([companyId, month, year])
}

model RegistrationToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  company    Company  @relation(fields: [companyId], references: [id])
  companyId  Int
  isActive   Boolean  @default(true)
  createdBy  String   // Email пользователя, создавшего токен
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())

  @@index([companyId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  action    String   // e.g., "CREATE_EMPLOYEE", "UPLOAD_DOCUMENT"
  details   String   @db.Text
  userId    Int      // ID пользователя, совершившего действие
  companyId Int?     // ID компании (null для действий суперадмина)
  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([userId])
}
